<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Signing App</title>
    <style>
        /* Reset and basic styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .app-section {
            margin-bottom: 20px;
        }

        /* PDF upload section */
        .upload-section {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .upload-section.active {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }

        #file-input {
            display: none;
        }

        .upload-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        /* PDF viewer */
        #pdf-viewer {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            overflow: auto;
            margin-bottom: 20px;
            display: none;
        }

        #pdf-renderer {
            width: 100%;
        }

        /* Signature pad */
        .signature-section {
            display: none;
        }

        #signature-pad {
            border: 1px solid #ddd;
            width: 100%;
            height: 200px;
            background-color: white;
        }

        .signature-tools {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .clear-btn {
            background-color: #f44336;
            color: white;
        }

        .apply-btn {
            background-color: #2196F3;
            color: white;
        }

        /* Position controls */
        .position-controls {
            margin-top: 20px;
            display: none;
        }

        .position-inputs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .position-inputs input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .save-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            width: 100%;
        }

        /* Page navigation */
        .page-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDF Signing App</h1>
        
        <!-- Upload Section -->
        <div class="app-section upload-section" id="drop-area">
            <p>Drag & drop file PDF Anda di sini, atau</p>
            <input type="file" id="file-input" accept="application/pdf">
            <button class="upload-btn" onclick="document.getElementById('file-input').click()">Pilih File</button>
            <p id="file-name"></p>
        </div>
        
        <!-- PDF Viewer -->
        <div class="app-section" id="pdf-viewer">
            <div class="page-nav">
                <button class="action-btn" id="prev-page">Halaman Sebelumnya</button>
                <span id="page-num"></span>
                <button class="action-btn" id="next-page">Halaman Berikutnya</button>
            </div>
            <canvas id="pdf-renderer"></canvas>
        </div>
        
        <!-- Signature Pad -->
        <div class="app-section signature-section" id="signature-section">
            <h2>Buat Tanda Tangan</h2>
            <canvas id="signature-pad"></canvas>
            <div class="signature-tools">
                <button class="action-btn clear-btn" id="clear-signature">Hapus</button>
                <button class="action-btn apply-btn" id="apply-signature">Terapkan Tanda Tangan</button>
            </div>
        </div>
        
        <!-- Position Controls -->
        <div class="app-section position-controls" id="position-controls">
            <h2>Posisi Tanda Tangan</h2>
            <div class="position-inputs">
                <label>
                    Halaman:
                    <input type="number" id="sig-page" min="1" value="1">
                </label>
                <label>
                    X:
                    <input type="number" id="sig-x" value="100">
                </label>
                <label>
                    Y:
                    <input type="number" id="sig-y" value="100">
                </label>
                <label>
                    Lebar:
                    <input type="number" id="sig-width" value="200">
                </label>
            </div>
            <button class="save-btn" id="save-pdf">Simpan PDF yang Ditandatangani</button>
        </div>
    </div>

    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <!-- Signature Pad Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.0.8/signature_pad.umd.min.js"></script>
    
    <!-- PDF-LIB for PDF Manipulation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    
    <script>
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        // Global variables
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.5;
        let canvas = document.getElementById('pdf-renderer');
        let ctx = canvas.getContext('2d');
        let signaturePad = null;
        let signatureImage = null;
        let pdfBytes = null;
        
        // Initialize signature pad
        function initSignaturePad() {
            const signatureCanvas = document.getElementById('signature-pad');
            signaturePad = new SignaturePad(signatureCanvas, {
                backgroundColor: 'white',
                penColor: 'black',
                minWidth: 1,
                maxWidth: 2.5
            });
            
            document.getElementById('clear-signature').addEventListener('click', function() {
                signaturePad.clear();
            });
            
            document.getElementById('apply-signature').addEventListener('click', function() {
                if (signaturePad.isEmpty()) {
                    alert('Silakan buat tanda tangan terlebih dahulu');
                    return;
                }
                
                signatureImage = signaturePad.toDataURL();
                document.getElementById('position-controls').style.display = 'block';
            });
        }
        
        // Render specific page of PDF
        function renderPage(num) {
            pageRendering = true;
            
            // Get page
            pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({ scale: scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                // Render PDF page into canvas context
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);
                
                // Wait for rendering to finish
                renderTask.promise.then(function() {
                    pageRendering = false;
                    
                    if (pageNumPending !== null) {
                        // New page rendering is pending
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });
            
            // Update page counters
            document.getElementById('page-num').textContent = `Halaman ${num} dari ${pdfDoc.numPages}`;
        }
        
        // Go to previous page
        function onPrevPage() {
            if (pageNum <= 1) {
                return;
            }
            pageNum--;
            queueRenderPage(pageNum);
        }
        
        // Go to next page
        function onNextPage() {
            if (pageNum >= pdfDoc.numPages) {
                return;
            }
            pageNum++;
            queueRenderPage(pageNum);
        }
        
        // Queue rendering of the page
        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }
        
        // Handle file upload
        function handleFileSelect(event) {
            const file = event.target.files[0] || event.dataTransfer.files[0];
            
            if (file && file.type === 'application/pdf') {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const typedArray = new Uint8Array(e.target.result);
                    pdfBytes = typedArray;
                    
                    // Load PDF with PDF.js
                    pdfjsLib.getDocument(typedArray).promise.then(function(pdf) {
                        pdfDoc = pdf;
                        document.getElementById('pdf-viewer').style.display = 'block';
                        document.getElementById('signature-section').style.display = 'block';
                        document.getElementById('file-name').textContent = file.name;
                        
                        // Initial render
                        renderPage(pageNum);
                    });
                };
                
                reader.readAsArrayBuffer(file);
            } else {
                alert('Silakan pilih file PDF');
            }
        }
        
        // Handle drag and drop
        function setupDragAndDrop() {
            const dropArea = document.getElementById('drop-area');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.classList.add('active');
            }
            
            function unhighlight() {
                dropArea.classList.remove('active');
            }
            
            dropArea.addEventListener('drop', handleFileSelect, false);
        }
        
        // Save signed PDF
        async function savePDF() {
            if (!pdfBytes || !signatureImage) {
                alert('Silakan unggah file PDF dan buat tanda tangan terlebih dahulu');
                return;
            }
            
            try {
                // Load PDFLib
                const { PDFDocument, rgb } = PDFLib;
                
                // Load existing PDF
                const pdfDoc = await PDFDocument.load(pdfBytes);
                
                // Get signature positioning data
                const sigPage = parseInt(document.getElementById('sig-page').value) - 1; // Convert to 0-based index
                const sigX = parseInt(document.getElementById('sig-x').value);
                const sigY = parseInt(document.getElementById('sig-y').value);
                const sigWidth = parseInt(document.getElementById('sig-width').value);
                
                if (sigPage < 0 || sigPage >= pdfDoc.getPageCount()) {
                    alert(`Halaman harus antara 1 dan ${pdfDoc.getPageCount()}`);
                    return;
                }
                
                // Get the selected page
                const page = pdfDoc.getPages()[sigPage];
                const pageHeight = page.getHeight();
                
                // Convert signature image to a format PDFLib can use
                const signatureImageData = signatureImage.split(',')[1];
                const signatureImageBytes = Uint8Array.from(atob(signatureImageData), c => c.charCodeAt(0));
                const signatureImageEmbed = await pdfDoc.embedPng(signatureImageBytes);
                
                // Calculate height proportionally
                const aspectRatio = signatureImageEmbed.height / signatureImageEmbed.width;
                const sigHeight = sigWidth * aspectRatio;
                
                // Add signature image to the PDF
                page.drawImage(signatureImageEmbed, {
                    x: sigX,
                    y: pageHeight - sigY - sigHeight, // Convert to PDF coordinate system (origin at bottom-left)
                    width: sigWidth,
                    height: sigHeight,
                });
                
                // Save the PDF
                const modifiedPdfBytes = await pdfDoc.save();
                
                // Create a download link
                const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'signed_document.pdf';
                link.click();
                
            } catch (error) {
                console.error('Error saving PDF:', error);
                alert('Terjadi kesalahan saat menyimpan PDF: ' + error.message);
            }
        }
        
        // Initialize the application
        function init() {
            // Set up event listeners
            document.getElementById('file-input').addEventListener('change', handleFileSelect);
            document.getElementById('prev-page').addEventListener('click', onPrevPage);
            document.getElementById('next-page').addEventListener('click', onNextPage);
            document.getElementById('save-pdf').addEventListener('click', savePDF);
            
            // Initialize signature pad
            initSignaturePad();
            
            // Set up drag and drop
            setupDragAndDrop();
        }
        
        // Run initialization when the page is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
